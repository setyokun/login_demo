name: Build & Upload APK to BrowserStack

on:
  push:
    branches: [master]

jobs:
  build-apk:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Source
      uses: actions/checkout@v3

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.29.3'

    - name: Install Dependencies
      run: flutter pub get

    - name: Build Release APK
      run: flutter build apk --release

    - name: Upload APK to BrowserStack
      run: |
        curl -u "${{ secrets.BROWSERSTACK_USERNAME }}:${{ secrets.BROWSERSTACK_ACCESS_KEY }}" \
        -X POST "https://api-cloud.browserstack.com/app-automate/upload" \
        -F "file=@build/app/outputs/flutter-apk/app-release.apk" > bs_upload_result.json

    - name: Output APP URL
      run: |
        echo "APP_URL=$(jq -r .app_url bs_upload_result.json)" >> $GITHUB_ENV
        echo "âœ… APK uploaded to BrowserStack."